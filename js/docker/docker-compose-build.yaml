version: '3.7'
services:
  front-envoy:
    image: emulator_envoy:latest
    build:
      context: .
      dockerfile: envoy.Dockerfile
    networks:
      - envoymesh
    expose:
      - '8080'
      - '8001'
      - '8443'
    ports:
      - '80:8080'
      - '443:8443'
      - '8001:8001'

  emulator:
    image: emulator_emulator:latest
    build:
      context: ../../src
      dockerfile: Dockerfile
      shm_size: 128M
    runtime: nvidia
    networks:
      envoymesh:
        aliases:
          - emulator
    environment:
      - DISPLAY
      - TURN=printf {"iceServers":[{"urls":"turn:global.turn.twilio.com:3478?transport=tcp","username":"e27098fc9f94798b643109ab84f040a1d8cae654bfefb2ad220ee97d18641c91","credential":"agMbuOL2p5YMDH+jGV7L2i1SZxnF+MQ07xWGdYwMg+I="}]}
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,video,utility
    devices: [/dev/kvm]
    shm_size: 128M
    volumes:
      - /tmp/.X11-unix:/tmp/.X11-unix
    expose:
      - '8554'

  jwt_signer:
    image: emulator_jwt_signer:latest
    build:
      context: ../jwt-provider
      dockerfile: Dockerfile
    networks:
      envoymesh:
        aliases:
          - jwt_signer
    expose:
      - '8080'

  nginx:
    image: emulator_nginx:latest
    build:
      context: ..
      dockerfile: docker/nginx.Dockerfile
    networks:
      envoymesh:
        aliases:
          - nginx
    expose:
      - '80'

networks:
  envoymesh: {}
